@page "/"
@using SnowDayPredictor.Services
@using SnowDayPredictor.Models
@using SnowDayPredictor.Pages
@inject WeatherService WeatherService
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<PageTitle>Snow Day Predictor</PageTitle>

<div class="container">
    <div class="main-content">
        <h1>❄️ Snow Day Predictor</h1>

        <p>Enter your ZIP code to see the chance of snow days in your area over the next week.</p>

        <div class="input-container">
            <SavedLocations locations="@savedLocations"
                            CurrentZipCode="@zipCode"
                            OnLocationSelected="@LoadSavedLocation"
                            OnLocationDeleted="@DeleteSavedLocation" />

            <div class="input-section mb-4">
                <div class="zip-input-group">
                    <button class="btn btn-outline-secondary btn-sm location-btn"
                            @onclick="UseMyLocation"
                            disabled="@isLoading"
                            title="Use my current location">
                        📍
                    </button>
                    <input type="text"
                           class="form-control"
                           @bind="zipCode"
                           @bind:event="oninput"
                           placeholder="Enter ZIP code"
                           maxlength="5"
                           @onkeydown="HandleKeyPress" />
                    <button class="btn btn-primary" @onclick="() => GetForecast()" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span>Loading...</span>
                        }
                        else
                        {
                            <span>Get Forecast</span>
                        }
                    </button>
                    <button class="btn btn-outline-secondary"
                            @onclick="() => RefreshForecast()"
                            disabled="@isLoading"
                            title="Force refresh forecast (bypasses 5-min cache)">
                        🔄
                    </button>
                </div>
            </div>
        </div>

        @if (errorMessage != null)
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @if (isLoading && !string.IsNullOrEmpty(loadingStatus))
        {
            <div class="loading-status">
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="status-text">@loadingStatus</div>
            </div>
        }

        @if (forecasts != null && forecasts.Any())
        {
            <h3 class="forecast-title-header">7-Day Snow Day Forecast</h3>

            @if (!string.IsNullOrEmpty(currentCityName))
            {
                <div class="location-info-card">
                    <div class="location-info-main">
                        <div class="location-name-large">📍 @currentCityName</div>
                        @if (currentGeography != null)
                        {
                            <div class="location-details">
                                <div class="location-detail-row">
                                    <span>❄️ Snow Prep: @GetPreparednessLabel(currentGeography.PreparednessIndex) @GetPreparednessEmoji(currentGeography.PreparednessIndex)</span>
                                </div>
                                <div class="location-detail-row">
                                    <span>📏 Annual Snowfall: @currentGeography.AvgAnnualSnowfall"</span>
                                </div>
                                <div class="location-badge">@GetPreparednessBadge(currentGeography.PreparednessIndex, currentGeography.AvgAnnualSnowfall)</div>
                            </div>
                        }
                    </div>
                    @if (cacheTime.HasValue)
                    {
                        <div class="location-updated">Updated: @cacheTime.Value.ToString("h:mm tt")</div>
                    }
                </div>
            }

            @if (activeAlerts.Any(a => !a.Headline.StartsWith("Historical:")))
            {
                <div class="alerts-section">
                    @foreach (var alert in activeAlerts.Where(a => !a.Headline.StartsWith("Historical:")))
                    {
                        var alertClass = alert.Severity switch
                        {
                            AlertSeverity.Extreme => "alert-extreme",
                            AlertSeverity.Warning => "alert-warning",
                            AlertSeverity.Watch => "alert-watch",
                            _ => "alert-advisory"
                        };

                        <div class="weather-alert @alertClass">
                            <div class="alert-icon">⚠️</div>
                            <div class="alert-content">
                                <div class="alert-title">@alert.Type</div>
                                <div class="alert-headline">@alert.Headline</div>
                                @if (alert.Expires.HasValue)
                                {
                                    <div class="alert-expires">Until @alert.Expires.Value.ToString("ddd, MMM dd h:mm tt")</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            @if (schoolClosings != null && schoolClosings.Total > 0)
            {
                <div class="closings-section">
                    <div class="closings-header" @onclick="() => closingsExpanded = !closingsExpanded">
                        <span class="closings-icon">🏫</span>
                        <span class="closings-title">@schoolClosings.Total School Closing@(schoolClosings.Total == 1 ? "" : "s") in @currentGeography?.County County</span>
                        <span class="closings-toggle">@(closingsExpanded ? "▲" : "▼")</span>
                    </div>
                    @if (closingsExpanded)
                    {
                        <div class="closings-list">
                            @foreach (var closing in schoolClosings.Items.Take(10))
                            {
                                <div class="closing-item">
                                    <span class="closing-status @(closing.ClosureType == "closed" ? "status-closed" : "status-delay")">
                                        @closing.ClosureStatus
                                    </span>
                                    <span class="closing-name">@closing.OrganizationName</span>
                                    <span class="closing-date">@FormatClosingDate(closing.EffectiveDate)</span>
                                </div>
                            }
                            @if (schoolClosings.Total > 10)
                            {
                                <div class="closing-item closing-more">
                                    ... and @(schoolClosings.Total - 10) more
                                </div>
                            }
                            @if (schoolClosings.Source != null)
                            {
                                <div class="closings-source">
                                    <a href="@schoolClosings.Source.Url" target="_blank" rel="noopener">Source: @schoolClosings.Source.Name</a>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <div class="forecast-container">
                @foreach (var forecast in forecasts)
                {
                    var isWeekend = forecast.Date.DayOfWeek == DayOfWeek.Saturday ||
                    forecast.Date.DayOfWeek == DayOfWeek.Sunday;

                    <div class="forecast-card" style="border-left: 4px solid @(isWeekend ? "#6c757d" : forecast.ChanceColor)">
                        <div class="forecast-header">
                            <h4>@forecast.DayName</h4>
                            <span class="date">@forecast.Date.ToString("MMM dd")</span>
                        </div>

                        @if (isWeekend)
                        {
                            <!-- Weekend display - no closure/delay predictions -->
                            <div class="weekend-notice">
                                <div class="weekend-icon">📅</div>
                                <div class="weekend-text">No School - Weekend</div>
                            </div>
                        }
                        else
                        {
                            <!-- Weekday display - show closure and delay -->
                            <div class="snow-chance" style="border-color: @forecast.ChanceColor">
                                <div class="chance-type">CLOSURE</div>
                                <div class="percentage" style="color: @forecast.ChanceColor">@forecast.SnowDayChance%</div>
                                <div class="chance-label">@forecast.ChanceLevel Chance</div>
                            </div>

                            <div class="delay-chance" style="border-color: @forecast.DelayColor">
                                <div class="chance-type">DELAY</div>
                                <div class="percentage" style="color: @forecast.DelayColor">@forecast.DelayChance%</div>
                                <div class="chance-label">@forecast.DelayLevel Chance</div>
                            </div>
                        }

                        <div class="forecast-details">
                            @if (!string.IsNullOrEmpty(forecast.Reasoning) && forecast.Date.DayOfWeek != DayOfWeek.Saturday && forecast.Date.DayOfWeek != DayOfWeek.Sunday)
                            {
                                <div class="reasoning"><strong>Details:</strong> @forecast.Reasoning</div>
                            }
                            <div><strong>Temperature:</strong> @forecast.Temperature°F</div>
                            <div><strong>Precipitation:</strong> @forecast.PrecipitationChance%</div>
                            @if (!string.IsNullOrEmpty(forecast.SnowfallAmount))
                            {
                                <div>
                                    <strong>❄️ Expected Snow: </strong>
                                    @if (forecast.SnowfallAmount.Contains("\""))
                                    {
                                        <span>@forecast.SnowfallAmount</span>
                                    }
                                    else
                                    {
                                        <span class="qualitative-snow">@forecast.SnowfallAmount</span>
                                    }
                                </div>
                            }
                            <div class="mt-2"><strong>Forecast:</strong> @(!string.IsNullOrEmpty(forecast.DetailedForecast) ? forecast.DetailedForecast : forecast.Forecast)</div>
                        </div>
                    </div>
                }
            </div>
        }

    </div>
    <!-- Add version display here -->
    <div class="version-info">
        @if (!string.IsNullOrEmpty(appVersion))
        {
            <span>v@(appVersion)</span>
        }

    </div>
</div>

@code {
    private string zipCode = "";
    private string currentCityName = "";
    private bool isLoading = false;
    private string loadingStatus = "";
    private string? errorMessage = null;
    private List<SnowDayForecast>? forecasts = null;
    private List<SavedLocation> savedLocations = new();
    private const int MaxSavedLocations = 10;
    private string appVersion = "";
    private List<WeatherAlert> activeAlerts = new();
    private GeographyContext? currentGeography = null;
    private ClosingsResponse? schoolClosings = null;
    private bool closingsExpanded = false;

    // Cache management
    private string? cachedZipCode = null;
    private DateTime? cacheTime = null;
    private const int CacheMinutes = 5;
    private bool IsCacheValid => cachedZipCode == zipCode &&
                                 cacheTime.HasValue &&
                                 DateTime.Now.Subtract(cacheTime.Value).TotalMinutes < CacheMinutes;


    protected override async Task OnInitializedAsync()
    {
        await LoadSavedLocations();

        // Auto-load the most recently used location
        var lastLocation = savedLocations.FirstOrDefault();
        if (lastLocation != null)
        {
            zipCode = lastLocation.ZipCode;
            await GetForecast();
        }

        await LoadVersion();
    }

    private async Task LoadVersion()
    {
        try
        {
            var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./version.js");
            appVersion = await module.InvokeAsync<string>("getVersion");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Could not load version: {ex.Message}");

#if DEBUG
        appVersion = "dev-local";
#else
            appVersion = "unknown";
#endif
        }
    }

    public class VersionInfo
    {
        [System.Text.Json.Serialization.JsonPropertyName("version")]
        public string Version { get; set; } = "";

        [System.Text.Json.Serialization.JsonPropertyName("buildDate")]
        public string BuildDate { get; set; } = "";
    }

    private string GetPreparednessLabel(double p)
    {
        if (p < 0.30) return "Low";
        if (p < 0.55) return "Moderate";
        return "High";
    }

    private string GetPreparednessEmoji(double p)
    {
        if (p < 0.30) return "🟥";
        if (p < 0.55) return "🟨";
        return "🟩";
    }

    private string GetPreparednessBadge(double p, double annualSnowfall)
    {
        // Lake effect / extreme snow areas
        if (annualSnowfall >= 50 && p >= 0.90) return "🏆 Lake Effect Warriors";
        if (annualSnowfall >= 40 && p >= 0.80) return "⛷️ Snow Belt Veterans";

        // Standard prep levels
        if (p >= 0.70) return "🌨️ Winter Ready";
        if (p >= 0.50) return "❄️ Moderate Prep";
        if (p >= 0.30) return "🧊 Snow Day Hopefuls";
        return "🌴 Powder Panic Zone";
    }

    private string FormatClosingDate(string effectiveDate)
    {
        if (DateTime.TryParse(effectiveDate, out var date))
        {
            return $"({date.Month}/{date.Day})";
        }
        return "";
    }

    private async Task RefreshForecast()
    {
        if (string.IsNullOrEmpty(zipCode))
        {
            errorMessage = "No location to refresh. Please enter a ZIP code or select a saved location.";
            return;
        }

        // Force refresh bypasses cache
        await GetForecast(forceRefresh: true);
    }

    private async Task LoadSavedLocations()
    {
        try
        {
            var stored = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "savedLocations");
            if (!string.IsNullOrEmpty(stored))
            {
                savedLocations = System.Text.Json.JsonSerializer.Deserialize<List<SavedLocation>>(stored) ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading saved locations: {ex.Message}");
        }
    }

    private async Task SaveLocations()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(savedLocations);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "savedLocations", json);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving locations: {ex.Message}");
        }
    }

    private async Task AddOrUpdateSavedLocation(string zip, string cityName, bool updateLastUsed = true)
    {
        var existing = savedLocations.FirstOrDefault(l => l.ZipCode == zip);
        if (existing != null)
        {
            existing.CityName = cityName; // Update city name
            if (updateLastUsed)
            {
                existing.LastUsed = DateTime.Now;
            }
        }
        else
        {
            savedLocations.Insert(0, new SavedLocation
            {
                ZipCode = zip,
                CityName = cityName,
                LastUsed = DateTime.Now
            });

            // Keep only the most recent locations
            if (savedLocations.Count > MaxSavedLocations)
            {
                savedLocations = savedLocations.Take(MaxSavedLocations).ToList();
            }
        }

        // Only sort when adding new locations, not when reloading existing ones
        if (updateLastUsed)
        {
            savedLocations = savedLocations.OrderByDescending(l => l.LastUsed).ToList();
        }

        await SaveLocations();
    }

    private async Task DeleteSavedLocation(string zip)
    {
        savedLocations.RemoveAll(l => l.ZipCode == zip);
        await SaveLocations();

        // If we deleted the currently selected location, clear it
        if (zipCode == zip)
        {
            zipCode = "";
            forecasts = null;
            activeAlerts = new();
            currentCityName = "";
        }
    }

    private async Task LoadSavedLocation(string locationCode)
    {
        // Only handle regular ZIP codes (we filtered out LOC: entries)
        zipCode = locationCode;

        // Update the LastUsed timestamp for this location
        // But DON'T re-sort yet - wait until forecast completes successfully
        var location = savedLocations.FirstOrDefault(l => l.ZipCode == locationCode);
        if (location != null)
        {
            location.LastUsed = DateTime.Now;
            // Don't save yet - will be saved after successful forecast
        }

        await GetForecast();
    }

    private async Task GetForecast(bool forceRefresh = false)
    {
        if (string.IsNullOrWhiteSpace(zipCode) || zipCode.Length != 5 || !zipCode.All(char.IsDigit))
        {
            errorMessage = "Please enter a valid 5-digit ZIP code.";
            return;
        }

        // Check cache first
        if (!forceRefresh && IsCacheValid)
        {
            var minutesRemaining = CacheMinutes - DateTime.Now.Subtract(cacheTime!.Value).TotalMinutes;
            errorMessage = $"Using cached data. Refresh available in {Math.Ceiling(minutesRemaining)} minute(s).";
            return;
        }

        // Clear previous forecast and show loading
        errorMessage = null;
        forecasts = null;
        activeAlerts = new();
        isLoading = true;
        loadingStatus = "Getting location data...";
        StateHasChanged();
        await Task.Delay(10); // Allow UI to update

        try
        {
            // Step 1: Convert ZIP to coordinates
            loadingStatus = "Getting location data...";
            StateHasChanged();

            var coords = await WeatherService.GetCoordinatesFromZip(zipCode);
            if (!coords.HasValue)
            {
                errorMessage = $"Could not find location for ZIP code {zipCode}. Please try another ZIP code or use 'Use My Location' instead.";
                Console.WriteLine($"ERROR: GetCoordinatesFromZip returned null for ZIP {zipCode}");
                return;
            }

            // Get city name from ZIP (separate call with fallbacks)
            var (cityName, stateName) = await WeatherService.GetCityNameFromZip(zipCode);
            currentCityName = string.IsNullOrEmpty(stateName) ? cityName : $"{cityName}, {stateName}";
            Console.WriteLine($"City name from ZIP: {currentCityName}");

            // Step 2: Get weather forecast
            loadingStatus = "Getting weather forecast...";
            StateHasChanged();

            var (weatherData, nwsCity, nwsState, wfoCode, countyName) = await WeatherService.GetWeatherForecast(coords.Value.lat, coords.Value.lon);
            if (weatherData == null)
            {
                errorMessage = "Could not retrieve weather data. The National Weather Service API may be temporarily unavailable.";
                return;
            }

            // Step 3: Get climate data (cached in localStorage)
            loadingStatus = "Getting climate data...";
            StateHasChanged();

            var geography = new GeographyContext
            {
                State = stateName, // Use state from ZIP lookup
                County = countyName, // County from NWS
                Latitude = coords.Value.lat,
                Longitude = coords.Value.lon
            };

            // This will use localStorage cache automatically
            var climateData = await WeatherService.GetClimateDataAsync(geography.Latitude, geography.Longitude);
            if (climateData != null)
            {
                geography.AvgAnnualSnowfall = climateData.AvgAnnualSnowfall;
            }
            currentGeography = geography;

            // Step 4: Get historical weather data (last 3 days)
            loadingStatus = "Getting recent weather history...";
            StateHasChanged();

            var historicalWeather = await WeatherService.GetRecentWeather(coords.Value.lat, coords.Value.lon, daysBack: 3);

            // Step 5: Get active weather alerts
            loadingStatus = "Checking weather alerts...";
            StateHasChanged();

            var allAlerts = await WeatherService.GetActiveAlerts(coords.Value.lat, coords.Value.lon);

            // Filter to only relevant alerts for the 7-day forecast window
            var forecastEndDate = DateTime.Today.AddDays(7);
            activeAlerts = allAlerts.Where(a =>
            {
                // Filter out expired alerts
                if (a.Expires.HasValue && a.Expires.Value < DateTime.Now)
                {
                    Console.WriteLine($"Filtering out expired alert: {a.Type}");
                    return false;
                }

                // Filter out alerts that don't overlap with our 7-day window
                var effectiveEnd = a.Ends ?? a.Expires ?? DateTime.MaxValue;
                var startsAfterWindow = a.Onset.HasValue && a.Onset.Value.Date > forecastEndDate;
                var endsBeforeWindow = effectiveEnd.Date < DateTime.Today;

                if (startsAfterWindow || endsBeforeWindow)
                {
                    Console.WriteLine($"Filtering out alert outside forecast window: {a.Type}");
                    return false;
                }

                // Only show advisory-level or higher (filter out statements/outlooks)
                if (a.Severity < AlertSeverity.Advisory)
                {
                    Console.WriteLine($"Filtering out low-severity alert: {a.Type}");
                    return false;
                }

                return true;
            }).ToList();

            // Step 5b: Get historical alerts from IEM (for aftermath calculations)
            // Always fetch - we need storm history even if current alerts have expired
            if (!string.IsNullOrEmpty(wfoCode))
            {
                loadingStatus = "Checking recent weather history...";
                StateHasChanged();

                var historicalAlerts = await WeatherService.GetHistoricalAlertsAsync(wfoCode, daysBack: 7);

                // Add historical alerts that aren't already in active alerts (avoid duplicates)
                foreach (var histAlert in historicalAlerts)
                {
                    // Check if we already have an active alert covering the same period
                    bool isDuplicate = activeAlerts.Any(a =>
                        a.Type == histAlert.Type &&
                        a.Onset?.Date == histAlert.Onset?.Date);

                    if (!isDuplicate)
                    {
                        activeAlerts.Add(histAlert);
                        Console.WriteLine($"Added historical alert to context: {histAlert.Type} ({histAlert.Onset:MM/dd})");
                    }
                }
            }

            // Step 5c: Get school closings (if we have county data)
            if (!string.IsNullOrEmpty(geography.County) && !string.IsNullOrEmpty(geography.State))
            {
                loadingStatus = "Checking school closings...";
                StateHasChanged();

                schoolClosings = await WeatherService.GetSchoolClosingsAsync(geography.State, geography.County);
                closingsExpanded = false; // Reset expansion state
            }
            else
            {
                schoolClosings = null;
            }

            // Step 6: Calculate snow day chances WITH historical context AND alerts
            loadingStatus = "Calculating snow day probabilities...";
            StateHasChanged();

            forecasts = await WeatherService.CalculateSnowDayChancesAsync(weatherData, geography, historicalWeather, activeAlerts);

            Console.WriteLine($"Geography - State: {geography.State}, Preparedness: {geography.PreparednessIndex:F2}, Snowfall: {geography.AvgAnnualSnowfall}\"");

            if (!forecasts.Any())
            {
                errorMessage = "No forecast data available for your location.";
            }
            else
            {
                // Save or update location with current timestamp
                await AddOrUpdateSavedLocation(zipCode, currentCityName, updateLastUsed: true);

                // Force UI update after re-sort
                StateHasChanged();

                // Update cache
                cachedZipCode = zipCode;
                cacheTime = DateTime.Now;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
            loadingStatus = "";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            InvalidateCacheIfNeeded();
            await Task.Delay(10);
            await GetForecast();
        }
    }

    private async Task UseMyLocation()
    {
        // Clear previous forecast and show loading
        errorMessage = null;
        forecasts = null;
        activeAlerts = new();
        isLoading = true;
        loadingStatus = "Getting your location...";
        StateHasChanged();
        await Task.Delay(10); // Allow UI to update

        try
        {
            var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./Pages/Home.razor.js");

            try
            {
                var position = await module.InvokeAsync<GeolocationPosition>("getLocation");

                Console.WriteLine($"Got location: {position.Latitude}, {position.Longitude}");

                // Get city name from coordinates
                loadingStatus = "Getting location name...";
                StateHasChanged();

                var (cityName, state) = await WeatherService.GetCityNameFromCoordinates(position.Latitude, position.Longitude);
                currentCityName = string.IsNullOrEmpty(state) ? cityName : $"{cityName}, {state}";

                // Get weather forecast
                loadingStatus = "Getting weather forecast...";
                StateHasChanged();

                var (weatherData, nwsCity, nwsState, wfoCode, countyName) = await WeatherService.GetWeatherForecast(position.Latitude, position.Longitude);
                if (weatherData == null)
                {
                    errorMessage = "Could not retrieve weather data for your location.";
                    return;
                }

                // Get climate data (cached in localStorage)
                loadingStatus = "Getting climate data...";
                StateHasChanged();

                var geography = new GeographyContext
                {
                    State = state,
                    County = countyName, // County from NWS
                    Latitude = position.Latitude,
                    Longitude = position.Longitude
                };

                // This will use localStorage cache automatically
                var climateData = await WeatherService.GetClimateDataAsync(geography.Latitude, geography.Longitude);
                if (climateData != null)
                {
                    geography.AvgAnnualSnowfall = climateData.AvgAnnualSnowfall;
                }
                currentGeography = geography;

                // Get historical weather data (last 3 days)
                loadingStatus = "Getting recent weather history...";
                StateHasChanged();

                var historicalWeather = await WeatherService.GetRecentWeather(position.Latitude, position.Longitude, daysBack: 3);

                // Get active weather alerts
                loadingStatus = "Checking weather alerts...";
                StateHasChanged();

                var allAlertsForLocation = await WeatherService.GetActiveAlerts(position.Latitude, position.Longitude);

                // Filter to only relevant alerts for the 7-day forecast window
                var forecastEndDate = DateTime.Today.AddDays(7);
                activeAlerts = allAlertsForLocation.Where(a =>
                {
                    // Filter out expired alerts
                    if (a.Expires.HasValue && a.Expires.Value < DateTime.Now)
                        return false;

                    // Filter out alerts that don't overlap with our 7-day window
                    var effectiveEnd = a.Ends ?? a.Expires ?? DateTime.MaxValue;
                    var startsAfterWindow = a.Onset.HasValue && a.Onset.Value.Date > forecastEndDate;
                    var endsBeforeWindow = effectiveEnd.Date < DateTime.Today;

                    if (startsAfterWindow || endsBeforeWindow)
                        return false;

                    // Only show advisory-level or higher
                    if (a.Severity < AlertSeverity.Advisory)
                        return false;

                    return true;
                }).ToList();

                // Always get historical alerts - we need storm history even if alerts expired
                if (!string.IsNullOrEmpty(wfoCode))
                {
                    var historicalAlerts = await WeatherService.GetHistoricalAlertsAsync(wfoCode, daysBack: 7);
                    foreach (var histAlert in historicalAlerts)
                    {
                        bool isDuplicate = activeAlerts.Any(a =>
                            a.Type == histAlert.Type &&
                            a.Onset?.Date == histAlert.Onset?.Date);

                        if (!isDuplicate)
                        {
                            activeAlerts.Add(histAlert);
                            Console.WriteLine($"Added historical alert: {histAlert.Type} ({histAlert.Onset:MM/dd})");
                        }
                    }
                }

                // Get school closings (if we have county data)
                if (!string.IsNullOrEmpty(geography.County) && !string.IsNullOrEmpty(geography.State))
                {
                    loadingStatus = "Checking school closings...";
                    StateHasChanged();

                    schoolClosings = await WeatherService.GetSchoolClosingsAsync(geography.State, geography.County);
                    closingsExpanded = false;
                }
                else
                {
                    schoolClosings = null;
                }

                // Calculate snow day chances
                loadingStatus = "Calculating snow day probabilities...";
                StateHasChanged();

                forecasts = await WeatherService.CalculateSnowDayChancesAsync(weatherData, geography, historicalWeather, activeAlerts);

                Console.WriteLine($"Location-based geography - State: {geography.State}, Preparedness: {geography.PreparednessIndex:F2}, Snowfall: {geography.AvgAnnualSnowfall}\"");

                if (!forecasts.Any())
                {
                    errorMessage = "No forecast data available for your location.";
                }
                else
                {
                    // Clear ZIP since we used coordinates
                    // Don't save location-based searches since they can't be reloaded
                    zipCode = "";
                }
            }
            catch (JSException jsEx)
            {
                Console.WriteLine($"JS Error: {jsEx.Message}");
                errorMessage = jsEx.Message.Contains("denied")
                    ? "Location permission denied. Please enable location access or enter your ZIP code."
                    : $"Could not get your location: {jsEx.Message}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Location error: {ex.Message}. Try entering your ZIP code instead.";
            Console.WriteLine($"Geolocation error: {ex}");
        }
        finally
        {
            isLoading = false;
            loadingStatus = "";
        }
    }


    private void InvalidateCacheIfNeeded()
    {
        // Clear cache if user changed the ZIP code
        if (cachedZipCode != zipCode)
        {
            cachedZipCode = null;
            cacheTime = null;
        }
    }

    public class GeolocationPosition
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }


}

<style>
    .input-section {
        max-width: 100%;
    }

    .zip-input-group {
        display: flex;
        gap: 0.5rem;
        align-items: stretch;
    }

        .zip-input-group .form-control {
            flex: 1;
        }

    .location-btn {
        padding: 0.375rem 0.75rem;
        font-size: 1.2rem;
        line-height: 1;
        border: 1px solid #dee2e6;
    }

        .location-btn:hover {
            background-color: #e9ecef;
        }

    .forecast-container {
        display: grid;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .forecast-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .forecast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

        .forecast-header h4 {
            margin: 0;
            font-size: 1.25rem;
        }

    .date {
        color: #666;
        font-size: 0.9rem;
    }

    .snow-chance {
        text-align: center;
        padding: 1rem;
        margin: 1rem 0;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .percentage {
        font-size: 3rem;
        font-weight: bold;
        line-height: 1;
    }

    .chance-label {
        font-size: 1rem;
        margin-top: 0.5rem;
        font-weight: 600;
    }

    .forecast-details {
        color: #333;
        font-size: 0.95rem;
        line-height: 1.6;
    }

        .forecast-details > div {
            margin-bottom: 0.5rem;
        }

    .forecast-title-header {
        margin-bottom: 1rem;
    }

    .location-info-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .location-info-main {
        flex: 1;
    }

    .location-name-large {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .location-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .location-detail-row {
        font-size: 0.9rem;
        color: #555;
    }

    .location-badge {
        margin-top: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        color: #495057;
    }

    .location-updated {
        font-size: 0.8rem;
        color: #888;
        text-align: right;
        white-space: nowrap;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem;
    }

    .main-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    @@media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        .container {
            padding: 0.5rem;
        }

        .location-info-card {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .location-updated {
            align-self: flex-end;
        }
    }

    .title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .last-updated {
        font-size: 0.85rem;
        color: #999;
        text-align: right;
        margin-top: 0.5rem;
    }

    .btn-outline-secondary {
        white-space: nowrap;
    }

    .qualitative-snow {
        font-style: italic;
        color: #666;
    }

    .snow-chance {
        text-align: center;
        padding: 1rem;
        margin: 0.5rem 0;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid;
    }

    .delay-chance {
        text-align: center;
        padding: 1rem;
        margin: 0.5rem 0;
        background: #f0f8ff;
        border-radius: 8px;
        border: 2px solid;
    }

    .chance-type {
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 1px;
        color: #666;
        margin-bottom: 0.25rem;
    }

    .percentage {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
    }

    .chance-label {
        font-size: 0.9rem;
        margin-top: 0.5rem;
        font-weight: 600;
    }

    .qualitative-snow {
        font-style: italic;
        color: #666;
    }

    .weekend-notice {
        text-align: center;
        padding: 2rem 1rem;
        margin: 1rem 0;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #6c757d;
    }

    .weekend-icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .weekend-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: #6c757d;
    }

    .version-info {
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.75rem;
        margin-top: 2rem;
    }

    .alerts-section {
        margin: 1rem 0;
    }

    .closings-section {
        margin: 1rem 0;
        background: #f0f7ff;
        border: 1px solid #b3d4fc;
        border-radius: 8px;
        overflow: hidden;
    }

    .closings-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        user-select: none;
        background: #e3f0ff;
        transition: background 0.2s;
    }

    .closings-header:hover {
        background: #d4e8ff;
    }

    .closings-icon {
        font-size: 1.25rem;
    }

    .closings-title {
        flex: 1;
        font-weight: 600;
        color: #1565c0;
    }

    .closings-toggle {
        color: #666;
        font-size: 0.8rem;
    }

    .closings-list {
        padding: 0.5rem 1rem 1rem;
    }

    .closing-date {
        color: #6c757d;
        font-size: 0.85rem;
        margin-left: auto;
    }

    .closing-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dce8f5;
    }

    .closing-item:last-child {
        border-bottom: none;
    }

    .closing-status {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
        white-space: nowrap;
    }

    .status-closed {
        background: #ffebee;
        color: #c62828;
    }

    .status-delay {
        background: #fff3e0;
        color: #e65100;
    }

    .closing-name {
        font-size: 0.9rem;
        color: #333;
    }

    .closing-more {
        font-style: italic;
        color: #666;
    }

    .closings-source {
        margin-top: 0.75rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dce8f5;
        font-size: 0.8rem;
    }

    .closings-source a {
        color: #1565c0;
        text-decoration: none;
    }

    .closings-source a:hover {
        text-decoration: underline;
    }

    .weather-alert {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid;
    }

    .alert-extreme {
        background: #ffe6e6;
        border-left-color: #dc3545;
    }

    .alert-warning {
        background: #fff3cd;
        border-left-color: #ff8c00;
    }

    .alert-watch {
        background: #cfe2ff;
        border-left-color: #0d6efd;
    }

    .alert-advisory {
        background: #d1ecf1;
        border-left-color: #17a2b8;
    }

    .alert-icon {
        font-size: 1.5rem;
        line-height: 1;
    }

    .alert-content {
        flex: 1;
    }

    .alert-title {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .alert-headline {
        font-size: 0.9rem;
        line-height: 1.4;
        margin-bottom: 0.25rem;
    }

    .alert-expires {
        font-size: 0.75rem;
        color: #666;
        font-style: italic;
    }

    /* Loading status styles */
    .loading-status {
        text-align: center;
        padding: 3rem 2rem;
        margin: 2rem 0;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #dee2e6;
    }

    .spinner-container {
        margin-bottom: 1rem;
    }

    .status-text {
        font-size: 1.1rem;
        color: #666;
        font-weight: 500;
    }
</style>
